<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<header th:replace="fragments/commonHeader :: common('Test Results')">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</header>

<body>

<div th:replace="fragments/currentUserFragment :: currentUser"></div>
<div th:replace="fragments/agentStatus :: agentStatus"></div>
<div class="container">
  <div id="testTemplate">
    <table>
      <thead>
      <tr>
        <th>Template id</th>
        <th>Target URL</th>
        <th>Method</th>
        <th>Max Request</th>
        <th>Max Duration</th>
      </tr>
      </thead>
      <tr>
        <td th:text="${template.id}"></td>
        <td th:text="${template.url}"></td>
        <td th:text="${template.method}"></td>
        <td th:text="${template.maxRequest}"></td>
        <td th:text="${template.maxDuration}"></td>
      </tr>
      <tbody>
    </table>

    <h2>Test Template Body</h2>
    <div style="background-color: #eeeeee">
      <pre id="jsonOutput"></pre>
    </div>

  <div id="buttons">
    <button id="startButton" onclick="sendAction('start')">시작</button>
    <button id="stopButton" onclick="sendAction('stop')">정지</button>
  </div>

  <h1>Test Results</h1>
  <div id="results">
    <table border="1">
      <thead>
      <tr>
        <th>Test ID</th>
        <th>Started At</th>
        <th>Finished At</th>
        <th>URL</th>
        <th>Method</th>
        <th>Total Requests</th>
        <th>Total Errors</th>
        <th>Total Success</th>
        <th>Total Users</th>
        <th>Total Duration</th>
        <th>MTTFB Average</th>
        <th>TPS Average</th>
        <th>Test Status</th>
        <!-- Add other table headers here -->
      </tr>
      </thead>
      <tbody id="resultsBody">
      <!-- Test results will be dynamically added here -->
      </tbody>
    </table>
  </div>

  <div id="results-status">
    <table border="1">
      <thead>
      <tr>
        <th>StatusCode</th>
        <th>count</th>
      </tr>
      </thead>
      <tbody id="statusCodeTableBody">
      <!-- Test results will be dynamically added here -->
      </tbody>
    </table>
  </div>
  <div id="results-mttfb">
    <table border="1">
      <thead>
      <tr>
        <th>mttfb percentile</th>
        <th>value</th>
      </tr>
      </thead>
      <tbody id="mttfbTableBody">
      <!-- Test results will be dynamically added here -->
      </tbody>
    </table>
  </div>
  <div id="results-tps">
    <table border="1">
      <thead>
      <tr>
        <th>tps percentile</th>
        <th>value</th>
      </tr>
      </thead>
      <tbody id="tpsTableBody">
      <!-- Test results will be dynamically added here -->
      </tbody>
    </table>
  </div>
</div>

<script>

  stompClient.activate();

  var stompClient2 = new StompJs.Client({
    brokerURL: 'ws://localhost:8080/gs-guide-websocket'
  });

  const userId = '[[${currentUser.id}]]';
  // get userId from securty context
  const groupId = '[[${groupId}]]';
  const templateId = [[${templateId}]];
  const jsonString = '[[${template.body}]]';
  var prettyJsonString = JSON.stringify(jsonString, null, 2); // 4 spaces for indentation
  document.getElementById('jsonOutput').innerText = prettyJsonString;

  stompClient2.onConnect = (frame) => {
    stompClient2.subscribe('/topic/' + groupId + '/' + templateId, (result) => {
      updateResults(JSON.parse(result.body));
    });
    stompClient2.subscribe('/topic/' + userId, (result) => {
      console.log('Received message: /topic/userId');
      alert('새로운 메시지가 도착했습니다: ' + result);
    });
  }


  function updateResults(result) {
    const resultsBody = document.getElementById('resultsBody');
    const statusCodeTableBody = document.getElementById('statusCodeTableBody');
    const mttfbTableBody = document.getElementById('mttfbTableBody');
    const tpsTableBody = document.getElementById('tpsTableBody');

    resultsBody.innerHTML = '';
    statusCodeTableBody.innerHTML = '';
    mttfbTableBody.innerHTML = '';
    tpsTableBody.innerHTML = '';

    const newRow = document.createElement('tr');

    for (const [statusCode, count] of Object.entries(result.status_code_count)) {
      const newRowForStatus = document.createElement('tr');
      newRowForStatus.innerHTML = `
            <td>${statusCode}</td>
            <td>${count}</td>
        `;
      statusCodeTableBody.appendChild(newRowForStatus);
    }
    for (const [mttfb, count] of Object.entries(result.mttfb_percentiles)) {
      const newRowForMttfb = document.createElement('tr');
      newRowForMttfb.innerHTML = `
            <td>${mttfb}</td>
            <td>${count}</td>
        `;
      mttfbTableBody.appendChild(newRowForMttfb);
    }
    for (const [tps, count] of Object.entries(result.tps_percentiles)) {
      const newRowForTps = document.createElement('tr');
      newRowForTps.innerHTML = `
            <td>${tps}</td>
            <td>${count}</td>
        `;
      tpsTableBody.appendChild(newRowForTps);
    }
    newRow.innerHTML = `
                <td>${result.test_id}</td>
                <td>${result.started_at}</td>
                <td>${result.finished_at}</td>
                <td>${result.url}</td>
                <td>${result.method}</td>
                <td>${result.total_requests}</td>
                <td>${result.total_errors}</td>
                <td>${result.total_success}</td>
                <td>${result.total_users}</td>
                <td>${result.total_duration}</td>
                <td>${result.mttfb_average}</td>
                <td>${result.tps_average}</td>
                <td>${result.test_status}</td>
                <!-- Add other table cells here -->
            `;
    resultsBody.appendChild(newRow);
  }

  function sendAction(action) {
    // You need to replace 'groupId' and 'templateId' with actual values
    const url = '/api/groups/' + groupId + '/templates/' + templateId + '?action=' + action;

    fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({})
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Failed to perform action');
      }
      console.log(action + ' action performed successfully');
    })
    .catch(error => {
      console.error('Error performing action:', error);
    });
  }

  stompClient2.activate();
</script>
</body>
</html>
