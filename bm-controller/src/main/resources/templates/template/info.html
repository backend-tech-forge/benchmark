<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
  <link rel="stylesheet" type="text/css" href="/css/styles.css">
  <link rel="stylesheet" type="text/css" href="/css/bar.css">

  <script src="/js/connectStomp.js"></script>
  <title>Test Results</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f2f2f2;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: #fff;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    h1 {
      color: #333;
      margin-top: 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }

    th {
      background-color: #f2f2f2;
      font-weight: bold;
    }

    tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    #buttons {
      margin-bottom: 20px;
    }

    #buttons button {
      padding: 10px 20px;
      margin-right: 10px;
      background-color: #007bff;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    #buttons button:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>

<div th:replace="fragments/currentUserFragment :: currentUser"></div>
<div class="container">
  <div id="testTemplate">
    <table>
      <thead>
      <tr>
        <th>Template id</th>
        <th>Target URL</th>
        <th>Method</th>
        <th>Max Request</th>
        <th>Max Duration</th>
      </tr>
      </thead>
      <tr>
        <td th:text="${template.id}"></td>
        <td th:text="${template.url}"></td>
        <td th:text="${template.method}"></td>
        <td th:text="${template.maxRequest}"></td>
        <td th:text="${template.maxDuration}"></td>
      </tr>
      <tbody>
    </table>

    <h2>Test Template Body</h2>
    <div style="background-color: #eeeeee">
      <pre id="jsonOutput"></pre>
    </div>

  <div id="buttons">
    <button id="startButton" onclick="sendAction('start')">시작</button>
    <button id="stopButton" onclick="sendAction('stop')">정지</button>
  </div>

  <h1>Test Results</h1>
  <div id="results">
    <table border="1">
      <thead>
      <tr>
        <th>Test ID</th>
        <th>Started At</th>
        <th>Finished At</th>
        <th>URL</th>
        <th>Method</th>
        <th>Total Requests</th>
        <th>Total Errors</th>
        <th>Total Success</th>
        <th>Total Users</th>
        <th>Total Duration</th>
        <th>MTTFB Average</th>
        <th>TPS Average</th>
        <th>Test Status</th>
        <!-- Add other table headers here -->
      </tr>
      </thead>
      <tbody id="resultsBody">
      <!-- Test results will be dynamically added here -->
      </tbody>
    </table>
  </div>

  <div id="results-status">
    <table border="1">
      <thead>
      <tr>
        <th>StatusCode</th>
        <th>count</th>
      </tr>
      </thead>
      <tbody id="statusCodeTableBody">
      <!-- Test results will be dynamically added here -->
      </tbody>
    </table>
  </div>
  <div id="results-mttfb">
    <table border="1">
      <thead>
      <tr>
        <th>mttfb percentile</th>
        <th>value</th>
      </tr>
      </thead>
      <tbody id="mttfbTableBody">
      <!-- Test results will be dynamically added here -->
      </tbody>
    </table>
  </div>
  <div id="results-tps">
    <table border="1">
      <thead>
      <tr>
        <th>tps percentile</th>
        <th>value</th>
      </tr>
      </thead>
      <tbody id="tpsTableBody">
      <!-- Test results will be dynamically added here -->
      </tbody>
    </table>
  </div>
</div>

<script th:inline="javascript">
  const userId = [[${currentUser.id}]];
  // get userId from securty context
  const groupId = [[${groupId}]]; // Replace with actual value
  const templateId = [[${templateId}]]; // Replace with actual value
  var initialized = [[${initialized}]];

  const jsonString = [[${template.body}]]
  var prettyJsonString = JSON.stringify(jsonString, null, 2); // 4 spaces for indentation
  document.getElementById('jsonOutput').innerText = prettyJsonString;

  initialize(userId,groupId,templateId);

  function initialize(userId,groupId,templateId) {
    if (!initialized) {
      stompClient = new StompJs.Client({
        brokerURL: 'ws://localhost:8080/gs-guide-websocket'
      });

      stompClient.onConnect = (frame) => {
        console.log('Connected: ' + frame);
        stompClient.subscribe('/topic/'+groupId+'/'+templateId, (result) => {
          updateResults(JSON.parse(result.body));
        });
        stompClient.subscribe('/topic/'+userId, (result) => {
          console.log('Received message: /topic/userId');
          alert('새로운 메시지가 도착했습니다: ' + result);
        });
      };

      stompClient.onWebSocketError = (error) => {
        console.error('Error with websocket', error);
      };
      initialized = true;
    }else{
      console.log('Already initialized');
    }
  }


  function updateResults(result) {
    const resultsBody = document.getElementById('resultsBody');
    const statusCodeTableBody = document.getElementById('statusCodeTableBody');
    const mttfbTableBody = document.getElementById('mttfbTableBody');
    const tpsTableBody = document.getElementById('tpsTableBody');

    resultsBody.innerHTML = '';
    statusCodeTableBody.innerHTML = '';
    mttfbTableBody.innerHTML = '';
    tpsTableBody.innerHTML = '';

    const newRow = document.createElement('tr');

    for (const [statusCode, count] of Object.entries(result.status_code_count)) {
      const newRowForStatus = document.createElement('tr');
      newRowForStatus.innerHTML = `
            <td>${statusCode}</td>
            <td>${count}</td>
        `;
      statusCodeTableBody.appendChild(newRowForStatus);
    }
    for (const [mttfb, count] of Object.entries(result.mttfb_percentiles)) {
      const newRowForMttfb = document.createElement('tr');
      newRowForMttfb.innerHTML = `
            <td>${mttfb}</td>
            <td>${count}</td>
        `;
      mttfbTableBody.appendChild(newRowForMttfb);
    }
    for (const [tps, count] of Object.entries(result.tps_percentiles)) {
      const newRowForTps = document.createElement('tr');
      newRowForTps.innerHTML = `
            <td>${tps}</td>
            <td>${count}</td>
        `;
      tpsTableBody.appendChild(newRowForTps);
    }
    newRow.innerHTML = `
                <td>${result.test_id}</td>
                <td>${result.started_at}</td>
                <td>${result.finished_at}</td>
                <td>${result.url}</td>
                <td>${result.method}</td>
                <td>${result.total_requests}</td>
                <td>${result.total_errors}</td>
                <td>${result.total_success}</td>
                <td>${result.total_users}</td>
                <td>${result.total_duration}</td>
                <td>${result.mttfb_average}</td>
                <td>${result.tps_average}</td>
                <td>${result.test_status}</td>
                <!-- Add other table cells here -->
            `;
    resultsBody.appendChild(newRow);
  }

  function sendAction(action) {
    // You need to replace 'groupId' and 'templateId' with actual values
    const url = '/api/groups/' + groupId + '/templates/' + templateId + '?action=' + action;

    fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({})
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Failed to perform action');
      }
      console.log(action + ' action performed successfully');
    })
    .catch(error => {
      console.error('Error performing action:', error);
    });
  }

  stompClient.activate();
</script>
</body>
</html>
